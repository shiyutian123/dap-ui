"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _xeUtils=_interopRequireDefault(require("xe-utils/methods/xe-utils")),_vXETable=_interopRequireDefault(require("../../v-x-e-table")),_tools=require("../../tools");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}var _default={methods:{_insert:function(e){return this.insertAt(e)},_insertAt:function(e,t){var l=this,o=this.afterFullData,i=this.editStore,r=this.scrollYLoad,n=this.tableFullData;if(this.treeConfig)throw new Error(_tools.UtilTools.getLog("vxe.error.noTree",["insert"]));_xeUtils.default.isArray(e)||(e=[e]);var s=o,c=e.map(function(e){return l.defineField(Object.assign({},e))});if(t)if(-1===t)s.push.apply(s,c),n.push.apply(n,c);else{var a=s.indexOf(t);if(-1===a)throw new Error(_tools.UtilTools.error("vxe.error.unableInsert"));s.splice.apply(s,[a,0].concat(c)),n.splice.apply(n,[n.indexOf(t),0].concat(c))}else s.unshift.apply(s,c),n.unshift.apply(n,c);return[].unshift.apply(i.insertList,c),this.handleTableData(),this.updateCache(),this.checkSelectionStatus(),r&&this.updateScrollYSpace(),this.$nextTick().then(function(){return l.recalculate(),{row:c.length?c[c.length-1]:null,rows:c}})},_remove:function(t){var e=this,l=this.afterFullData,o=this.tableFullData,i=this.editStore,r=this.treeConfig,n=this.checkboxOpts,s=this.selection,c=this.isInsertByRow,a=this.scrollYLoad,u=i.removeList,d=i.insertList,h=n.checkField,f=[],v=l;if(r)throw new Error(_tools.UtilTools.getLog("vxe.error.noTree",["remove"]));return t?_xeUtils.default.isArray(t)||(t=[t]):t=o,t.forEach(function(e){c(e)||u.push(e)}),h||_xeUtils.default.remove(s,function(e){return-1<t.indexOf(e)}),o===t?(t=f=o.slice(0),o.length=0,v.length=0):(f=_xeUtils.default.remove(o,function(e){return-1<t.indexOf(e)}),_xeUtils.default.remove(v,function(e){return-1<t.indexOf(e)})),_xeUtils.default.remove(d,function(e){return-1<t.indexOf(e)}),this.handleTableData(),this.updateCache(),this.checkSelectionStatus(),a&&this.updateScrollYSpace(),this.$nextTick().then(function(){return e.recalculate(),{row:f.length?f[f.length-1]:null,rows:f}})},_removeSelecteds:function(){var t=this;return this.remove(this.getCheckboxRecords()).then(function(e){return t.clearCheckboxRow(),e})},_getRecordset:function(){return{insertRecords:this.getInsertRecords(),removeRecords:this.getRemoveRecords(),updateRecords:this.getUpdateRecords()}},_getInsertRecords:function(){var t=this.editStore.insertList,l=[];return t.length&&this.tableFullData.forEach(function(e){-1<t.indexOf(e)&&l.push(e)}),l},_getRemoveRecords:function(){return this.editStore.removeList},_getUpdateRecords:function(){var e=this.tableFullData,t=this.isUpdateByRow,l=this.treeConfig,o=this.treeOpts;return l?_xeUtils.default.filterTree(e,function(e){return t(e)},o):e.filter(function(e){return t(e)})},handleActived:function(e,t){var l=this,o=this.editStore,i=this.editOpts,r=this.tableColumn,n=i.mode,s=i.activeMethod,c=o.actived,a=e.row,u=e.column,d=e.cell;if(u.editRender&&d)if(c.row!==a||"cell"===n&&c.column!==u){var h="edit-disabled";s&&!s(e)||((this.keyboardConfig||this.mouseConfig)&&(this.clearCopyed(t),this.clearChecked(),this.clearSelected(t)),this.clostTooltip(),this.clearActived(t),h="edit-actived",u.renderHeight=d.offsetHeight,c.args=e,c.row=a,c.column=u,"row"===n?r.forEach(function(e){return l._getColumnModel(a,e)}):this._getColumnModel(a,u),this.$nextTick(function(){l.handleFocus(e,t)})),_tools.UtilTools.emitEvent(this,h,[e,t])}else{var f=c.column;if(f!==u){var v=f.model;v.update&&_tools.UtilTools.setCellValue(a,f,v.value),this.clearValidate()}u.renderHeight=d.offsetHeight,c.args=e,c.column=u,setTimeout(function(){l.handleFocus(e,t)})}return this.$nextTick()},_getColumnModel:function(e,t){var l=t.model;t.editRender&&(l.value=_tools.UtilTools.getCellValue(e,t),l.update=!1)},_setColumnModel:function(e,t){var l=t.model;t.editRender&&l.update&&(_tools.UtilTools.setCellValue(e,t,l.value),l.update=!1,l.value=null)},_clearActived:function(e){var t=this,l=this.tableColumn,o=this.editStore,i=this.editOpts,r=o.actived,n=r.args,s=r.row,c=r.column;return(s||c)&&("row"===i.mode?l.forEach(function(e){return t._setColumnModel(s,e)}):this._setColumnModel(s,c),this.updateFooter(),_tools.UtilTools.emitEvent(this,"edit-closed",[n,e])),r.args=null,r.row=null,r.column=null,(_vXETable.default._valid?this.clearValidate():this.$nextTick()).then(this.recalculate)},_getActiveRow:function(){return this.getActiveRecord()},_getActiveRecord:function(){var e=this.$el,t=this.editStore,l=this.afterFullData,o=t.actived,i=o.args,r=o.row;return i&&-1<l.indexOf(r)&&e.querySelectorAll(".vxe-body--column.col--actived").length?Object.assign({},i):null},_hasActiveRow:function(e){return _tools.UtilTools.warn("vxe.error.delFunc",["hasActiveRow","isActiveByRow"]),this.isActiveByRow(e)},_isActiveByRow:function(e){return this.editStore.actived.row===e},handleFocus:function(e,t){var l=e.row,o=e.column,i=e.cell,r=o.editRender;if(r){var n,s=_vXETable.default.renderer.get(r.name),c=r.autofocus,a=r.autoselect;if(c&&(n=i.querySelector(c)),!n&&s&&s.autofocus&&(n=i.querySelector(s.autofocus)),n){if(n.focus(),a)n.select();else if(_tools.DomTools.browse.msie){var u=n.createTextRange();u.collapse(!1),u.select()}}else this.scrollToRow(l,o)}},_setActiveRow:function(e){return this.setActiveCell(e,_xeUtils.default.find(this.visibleColumn,function(e){return e.editRender}).property)},_setActiveCell:function(l,o){var i=this;return this.scrollToRow(l,!0).then(function(){if(l&&o){var e=_xeUtils.default.find(i.visibleColumn,function(e){return e.property===o});if(e&&e.editRender){var t=_tools.DomTools.getCell(i,{row:l,column:e});t&&(i.handleActived({row:l,rowIndex:i.getRowIndex(l),column:e,columnIndex:i.getColumnIndex(e),cell:t,$table:i}),i.lastCallTime=Date.now())}}return i.$nextTick()})},_setSelectCell:function(e,t){var l=this.tableData,o=this.editOpts,i=this.visibleColumn;if(e&&t&&"manual"!==o.trigger){var r=_xeUtils.default.find(i,function(e){return e.property===t}),n=l.indexOf(e);if(-1<n&&r){var s=_tools.DomTools.getCell(this,{row:e,rowIndex:n,column:r}),c={row:e,rowIndex:n,column:r,columnIndex:i.indexOf(r),cell:s};this.handleSelected(c,{})}}return this.$nextTick()},handleSelected:function(t,l){var o=this,e=this.mouseConfig,i=this.mouseOpts,r=this.editOpts,n=this.editStore,s=this.elemStore,c=n.actived,a=n.selected,u=t.row,d=t.column,h=t.cell,f=e&&i.selected,v=e&&(i.range||i.checked);return function(){if((f||v)&&(a.row!==u||a.column!==d)&&(c.row!==u||"cell"===r.mode&&c.column!==d)&&(o.keyboardConfig&&(o.clearChecked(l),o.clearIndexChecked(),o.clearHeaderChecked(),o.clearSelected(l)),o.clearActived(l),a.args=t,a.row=u,a.column=d,f&&o.addColSdCls(),v)){var e=s["main-header-list"];o.handleChecked([[h]]),e&&o.handleHeaderChecked([[e.querySelector(".".concat(d.id))]]),o.handleIndexChecked([[h.parentNode.querySelector(".col--seq")]])}return o.$nextTick()}()},_clearSelected:function(e){var t=this.editStore.selected;return t.row=null,t.column=null,this.reColTitleSdCls(),this.reColSdCls(),this.$nextTick()},reColTitleSdCls:function(){var e=this.elemStore["main-header-list"];e&&_xeUtils.default.arrayEach(e.querySelectorAll(".col--title-selected"),function(e){return _tools.DomTools.removeClass(e,"col--title-selected")})},reColSdCls:function(){var e=this.$el.querySelector(".col--selected");e&&_tools.DomTools.removeClass(e,"col--selected")},addColSdCls:function(){var e=this.editStore.selected,t=e.row,l=e.column;if(this.reColSdCls(),t&&l){var o=_tools.DomTools.getCell(this,{row:t,column:l});o&&_tools.DomTools.addClass(o,"col--selected")}}}};exports.default=_default;